# MiniSpdlog

MiniSpdlog 是一个从零实现的 轻量级、高可读性、高扩展性 的 C++ 日志库，核心思想参考成熟日志框架的设计理念，并结合自身需求进行结构化重构。项目旨在构建一个 模块化、易维护、可拓展 的日志组件，用于学习日志系统的底层机制，同时作为实际工程项目的可用基础设施。

该库覆盖一个日志系统的关键组成部分，包括：日志器（Logger）、输出端（Sink）、格式化器（Formatter）、日志级别控制、线程安全保障等。整体实现保持简洁，同时保留可扩展的框架结构，可作为进一步优化（异步日志、多 Sink、性能增强）的基础。

---

## 核心功能

1. 多级日志支持：Debug / Info / Warn / Error 等标准日志等级。
2. 模块化设计：Logger、Sink、Formatter 完全解耦，便于扩展新的输出端与格式化方式。
3. 可配置输出策略：控制台输出（Console Sink）、文件输出(File Sink）。
4. 格式化输出：基于互斥锁实现基本的同步日志写入，支持并发场景。
5. 轻量易用的 API：简洁的接口设计，使日志输出调用方式清晰流畅。

---

MiniSpdlog 采用分层结构设计，以便于扩展和维护。

### 1. Logger
负责：管理日志级别过滤逻辑、调用 Formatter 对消息进行格式化、将日志分发给多个 Sink。

### 2. Sink
输出端机制的核心抽象，支持：  
- ConsoleSink：输出到 stdout  
- FileSink：输出到文件  
- 可扩展更多 Sink（如滚动文件、网络输出等）

### 3. Formatter
用于将日志记录格式化为最终输出字符串，可自定义格式内容，如时间戳、线程 ID、日志等级等。

### 4. Level Filtering
Logger 与 Sink 均支持日志级别过滤，实现更灵活的控制策略。

---

## 项目架构

```
minispdlog/
│── include/
│   ├── logger.h
│   ├── sink.h
│   ├── formatter.h
│   └── level.h
│
│── src/
│   ├── logger.cpp
│   ├── sink.cpp
│   ├── formatter.cpp
│   └── file_sink.cpp
│
│── examples/
│   └── basic_usage.cpp
│
└── CMakeLists.txt
└── README.md
```

---

## MiniSpdlog 的开发初衷包括

- 通过动手实现日志框架，深入理解日志系统的关键设计模式（观察者、策略模式、责任链）。
- 构建一个可以直接用于小型项目或嵌入式系统的轻量级日志库。
- 为进一步的研究或工程优化（异步化、无锁队列、环形缓冲区、多线程性能分析等）奠定基础。
- 提升 C++ 工程能力，包括模块化设计、内存管理、API 设计、高内聚低耦合的代码结构。

---

## 性能优化

MiniSpdlog 在最初实现中，日志格式化部分（`pattern_formatter`）是影响整体吞吐能力的核心瓶颈。通过使用 `perf` 对同步日志路径进行性能分析，热点集中在以下调用链中：

- `pattern_formatter::format`
- `fmt::vformat_to`
- `fmt::detail::write_int_noinline`
- `std::uninitialized_copy_n`

根据分析结果，性能瓶颈主要来自以下三个方面：

### 1. 碎片化的格式化逻辑
对于pattern [%Y-%m-%d %H:%M:%S] [%l] %v，需要调用8次 fmt::format_to！每次调用都有函数开销。

### 2. 缺少文本聚合策略
格式化过程中存在大量小块内容的 append 操作，使写入路径离散化，影响 CPU cache locality，降低内存复制效率。

### 3. 数字格式化开销较高
线程 ID、毫秒级时间戳等字段使用通用格式化接口，会触发额外的类型推断和边界检查，导致不必要的性能损耗。

---

## 优化方案

基于上述问题，我对 Formatter 的实现进行了结构化重构，重点包括：

### • 日志模板预解析
将格式化 pattern（如 `%Y-%m-%d %H:%M:%S [%l] %t %v`）在初始化阶段解析为结构化片段，减少运行时逻辑分支与重复解析。

### • 连续缓冲区聚合输出
在格式化阶段使用连续内存缓冲区，将多段内容一次性聚合输出，减少 append 次数并降低内存分配频率。

### • 定制数值格式化函数
针对时间戳、线程 ID 等高频字段实现轻量级格式化逻辑，避免进入 fmt 的完整泛型路径。

---

## 优化效果概述

经过重构后：

- 日志格式化路径显著收敛，调用栈深度减少
- 热点函数中 fmt 相关占比明显下降
- 整体吞吐能力提升，同时保持接口简洁可扩展

该优化为后续进一步扩展（异步日志、零拷贝缓冲区、多 sink 并发输出等）提供了更稳定的基础。


## Build & Run

```bash
mkdir build && cd build
cmake ..
make -j$(nproc)

./test_performace
```

